<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - NesNes</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>NesNes</h1>
            </div>
            <div class="nav-menu">
                <a href="/index.html">Shop</a>
                <a href="/pages/cart.html">Cart (<span id="cart-count">0</span>)</a>
                <a href="/pages/admin.html" id="dashboard-link" style="display: none;">Dashboard</a>
                <span id="user-info" style="display: none;"></span>
                <a href="/pages/login.html" id="login-link">Login</a>
                <a href="#" id="logout-link" style="display: none;">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Cart Container -->
    <div class="container" style="margin-top: 2rem;">
        <h1>Shopping Cart</h1>
        <div class="cart-container">
            <div class="cart-items">
                <h2 id="cart-items-header">Cart Items (0)</h2>
                <div id="cart-items"></div>
                <div class="cart-summary" id="cart-summary" style="display: none;">
                    <div class="cart-total">
                        <h3>Total Amount: $<span id="total-amount">0.00</span></h3>
                    </div>
                </div>
            </div>
            <div id="empty-cart" style="text-align: center; padding: 3rem; display: none;">
                <p>Your cart is empty</p>
                <a href="/index.html" class="btn btn-primary">Continue Shopping</a>
            </div>
            <div class="checkout-form" id="checkout-section" style="display: none;">
                <h2>Checkout</h2>
            <form id="checkout-form">
                <div class="form-group">
                    <label for="fullName">Full Name *</label>
                    <input type="text" id="fullName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="address">Shipping Address</label>
                    <textarea id="address" class="form-control" rows="3"></textarea>
                </div>
                <div id="checkout-error" class="error-message" style="display: none;"></div>
                <div id="checkout-success" class="success-message" style="display: none;"></div>
                <button type="submit" class="btn btn-success" style="width: 100%;">Place Order</button>
            </form>
            </div>
        </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/cart.js"></script>
    <script>
        // Refresh cart items with full product data from API
        async function refreshCartData() {
            const cartItems = cart.getItems();

            for (let item of cartItems) {
                // If item is missing full data, fetch it from API
                if (!item.imageUrl || !item.Category) {
                    try {
                        const response = await fetch(`${API_ENDPOINTS.PRODUCTS}/${item.id}`);
                        if (response.ok) {
                            const fullProduct = await response.json();
                            // Update item with full data
                            item.imageUrl = fullProduct.imageUrl;
                            item.initialQuantity = fullProduct.initialQuantity;
                            item.Category = fullProduct.Category;
                            item.Brand = fullProduct.Brand;
                            item.Color = fullProduct.Color;
                            item.Size = fullProduct.Size;
                            item.Gender = fullProduct.Gender;
                        }
                    } catch (error) {
                        console.error('Error fetching product details:', error);
                    }
                }
            }

            // Save updated cart
            cart.saveCart();
        }

        function displayCart() {
            const cartItems = cart.getItems();
            console.log('Cart Items:', cartItems);
            const cartItemsDiv = document.getElementById('cart-items');
            const cartItemsHeader = document.getElementById('cart-items-header');
            const cartSummary = document.getElementById('cart-summary');
            const emptyCart = document.getElementById('empty-cart');
            const checkoutSection = document.getElementById('checkout-section');
            const totalAmount = document.getElementById('total-amount');

            if (cartItems.length === 0) {
                emptyCart.style.display = 'block';
                cartItemsHeader.style.display = 'none';
                cartSummary.style.display = 'none';
                checkoutSection.style.display = 'none';
                cartItemsDiv.style.display = 'none';
                return;
            }

            emptyCart.style.display = 'none';
            cartItemsHeader.style.display = 'block';
            cartItemsHeader.textContent = `Cart Items (${cartItems.length})`;
            cartSummary.style.display = 'block';
            checkoutSection.style.display = 'block';
            cartItemsDiv.style.display = 'block';

            cartItemsDiv.innerHTML = '';
            console.log('Creating cart items...');

            cartItems.forEach(item => {
                console.log('Processing item:', item);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    ${item.imageUrl ? `
                    <div class="cart-item-image">
                        <img src="${item.imageUrl}" alt="${item.name}">
                    </div>
                    ` : ''}
                    <div class="cart-item-details">
                        <div class="cart-item-info">
                            <h3>${item.name}</h3>
                            <p class="cart-item-description">${item.description || ''}</p>
                            <div class="cart-item-meta">
                                ${item.Gender?.name ? `<span class="meta-badge">${item.Gender.name}</span>` : ''}
                                ${item.Category?.name ? `<span class="meta-badge">${item.Category.name}</span>` : ''}
                                ${item.Brand?.name ? `<span class="meta-badge">${item.Brand.name}</span>` : ''}
                                ${item.Size?.name ? `<span class="meta-badge">Size: ${item.Size.name}</span>` : ''}
                                ${item.Color?.name ? `<span class="meta-badge">Color: ${item.Color.name}</span>` : ''}
                            </div>
                            <p class="cart-item-price">Price: $${parseFloat(item.price).toFixed(2)}</p>
                        </div>
                        <div class="cart-item-actions">
                            <div class="quantity-control">
                                <button class="qty-btn" onclick="updateCartItem(${item.id}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="qty-btn" onclick="updateCartItem(${item.id}, ${item.quantity + 1})" ${item.quantity >= (item.initialQuantity || 999) ? 'disabled' : ''}>+</button>
                            </div>
                            <div class="cart-item-subtotal">
                                <strong>Subtotal: $${(parseFloat(item.price) * item.quantity).toFixed(2)}</strong>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="removeCartItem(${item.id})">Remove</button>
                        </div>
                    </div>
                `;
                cartItemsDiv.appendChild(itemDiv);
                console.log('Appended item to cart');
            });

            console.log('Total items in DOM:', cartItemsDiv.children.length);
            totalAmount.textContent = cart.getTotal().toFixed(2);
        }

        function updateCartItem(productId, quantity) {
            cart.updateQuantity(productId, quantity);
            displayCart();
        }

        function removeCartItem(productId) {
            if (confirm('Remove this item from cart?')) {
                cart.removeItem(productId);
                displayCart();
            }
        }

        // Handle checkout
        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const address = document.getElementById('address').value;
            const errorDiv = document.getElementById('checkout-error');
            const successDiv = document.getElementById('checkout-success');

            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            const cartItems = cart.getItems();
            if (cartItems.length === 0) {
                errorDiv.textContent = 'Cart is empty';
                errorDiv.style.display = 'block';
                return;
            }

            // Prepare order data
            const orderData = {
                client: {
                    fullName,
                    email,
                    address
                },
                items: cartItems.map(item => ({
                    productId: item.id,
                    quantity: item.quantity
                }))
            };

            try {
                const response = await fetch(API_ENDPOINTS.ORDERS, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });

                const data = await response.json();

                if (response.ok) {
                    successDiv.textContent = `Order placed successfully! Total: $${data.totalAmount}`;
                    successDiv.style.display = 'block';

                    // Clear cart
                    cart.clear();

                    // Redirect after 3 seconds
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 3000);
                } else {
                    errorDiv.textContent = data.error || 'Failed to place order';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            }
        });

        // Display cart on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await refreshCartData();
            displayCart();
        });
    </script>
</body>
</html>
